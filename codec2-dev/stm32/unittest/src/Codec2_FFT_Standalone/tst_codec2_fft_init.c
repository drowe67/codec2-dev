#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <math.h>

#include "comp.h"
#include "codec2_fft.h"

#include "stm32f4xx_conf.h"
#include "stm32f4xx.h"
#include "semihosting.h"
#include "machdep.h"

#define FFT_ENC  512
#define M_PITCH_S  0.0400 

static const COMP wshift[] = {
    {0.004328,0.000000}, {0.004328,0.000000}, {0.004326,0.000000}, {0.004323,0.000000},
    {0.004320,0.000000}, {0.004315,0.000000}, {0.004309,0.000000}, {0.004301,0.000000},
    {0.004293,0.000000}, {0.004284,0.000000}, {0.004273,0.000000}, {0.004262,0.000000},
    {0.004249,0.000000}, {0.004236,0.000000}, {0.004221,0.000000}, {0.004205,0.000000},
    {0.004188,0.000000}, {0.004171,0.000000}, {0.004152,0.000000}, {0.004132,0.000000},
    {0.004111,0.000000}, {0.004089,0.000000}, {0.004066,0.000000}, {0.004043,0.000000},
    {0.004018,0.000000}, {0.003992,0.000000}, {0.003965,0.000000}, {0.003938,0.000000},
    {0.003909,0.000000}, {0.003880,0.000000}, {0.003850,0.000000}, {0.003819,0.000000},
    {0.003787,0.000000}, {0.003754,0.000000}, {0.003720,0.000000}, {0.003686,0.000000},
    {0.003651,0.000000}, {0.003615,0.000000}, {0.003578,0.000000}, {0.003541,0.000000},
    {0.003503,0.000000}, {0.003464,0.000000}, {0.003424,0.000000}, {0.003384,0.000000},
    {0.003344,0.000000}, {0.003302,0.000000}, {0.003260,0.000000}, {0.003218,0.000000},
    {0.003175,0.000000}, {0.003131,0.000000}, {0.003087,0.000000}, {0.003043,0.000000},
    {0.002998,0.000000}, {0.002953,0.000000}, {0.002907,0.000000}, {0.002861,0.000000},
    {0.002814,0.000000}, {0.002768,0.000000}, {0.002720,0.000000}, {0.002673,0.000000},
    {0.002625,0.000000}, {0.002577,0.000000}, {0.002529,0.000000}, {0.002481,0.000000},
    {0.002433,0.000000}, {0.002384,0.000000}, {0.002335,0.000000}, {0.002286,0.000000},
    {0.002238,0.000000}, {0.002189,0.000000}, {0.002140,0.000000}, {0.002091,0.000000},
    {0.002042,0.000000}, {0.001993,0.000000}, {0.001944,0.000000}, {0.001896,0.000000},
    {0.001847,0.000000}, {0.001799,0.000000}, {0.001751,0.000000}, {0.001703,0.000000},
    {0.001655,0.000000}, {0.001608,0.000000}, {0.001561,0.000000}, {0.001514,0.000000},
    {0.001468,0.000000}, {0.001421,0.000000}, {0.001376,0.000000}, {0.001330,0.000000},
    {0.001285,0.000000}, {0.001241,0.000000}, {0.001197,0.000000}, {0.001153,0.000000},
    {0.001110,0.000000}, {0.001068,0.000000}, {0.001026,0.000000}, {0.000985,0.000000},
    {0.000944,0.000000}, {0.000904,0.000000}, {0.000865,0.000000}, {0.000826,0.000000},
    {0.000788,0.000000}, {0.000750,0.000000}, {0.000714,0.000000}, {0.000678,0.000000},
    {0.000643,0.000000}, {0.000608,0.000000}, {0.000575,0.000000}, {0.000542,0.000000},
    {0.000510,0.000000}, {0.000479,0.000000}, {0.000448,0.000000}, {0.000419,0.000000},
    {0.000391,0.000000}, {0.000363,0.000000}, {0.000336,0.000000}, {0.000311,0.000000},
    {0.000286,0.000000}, {0.000262,0.000000}, {0.000239,0.000000}, {0.000217,0.000000},
    {0.000196,0.000000}, {0.000177,0.000000}, {0.000158,0.000000}, {0.000140,0.000000},
    {0.000123,0.000000}, {0.000107,0.000000}, {0.000093,0.000000}, {0.000079,0.000000},
    {0.000067,0.000000}, {0.000055,0.000000}, {0.000045,0.000000}, {0.000035,0.000000},
    {0.000027,0.000000}, {0.000020,0.000000}, {0.000014,0.000000}, {0.000009,0.000000},
    {0.000005,0.000000}, {0.000002,0.000000}, {0.000001,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000}, {0.000000,0.000000},
    {0.000000,0.000000}, {0.000000,0.000000}, {0.000001,0.000000}, {0.000002,0.000000},
    {0.000005,0.000000}, {0.000009,0.000000}, {0.000014,0.000000}, {0.000020,0.000000},
    {0.000027,0.000000}, {0.000035,0.000000}, {0.000045,0.000000}, {0.000055,0.000000},
    {0.000067,0.000000}, {0.000079,0.000000}, {0.000093,0.000000}, {0.000107,0.000000},
    {0.000123,0.000000}, {0.000140,0.000000}, {0.000158,0.000000}, {0.000177,0.000000},
    {0.000196,0.000000}, {0.000217,0.000000}, {0.000239,0.000000}, {0.000262,0.000000},
    {0.000286,0.000000}, {0.000311,0.000000}, {0.000336,0.000000}, {0.000363,0.000000},
    {0.000391,0.000000}, {0.000419,0.000000}, {0.000448,0.000000}, {0.000479,0.000000},
    {0.000510,0.000000}, {0.000542,0.000000}, {0.000575,0.000000}, {0.000608,0.000000},
    {0.000643,0.000000}, {0.000678,0.000000}, {0.000714,0.000000}, {0.000750,0.000000},
    {0.000788,0.000000}, {0.000826,0.000000}, {0.000865,0.000000}, {0.000904,0.000000},
    {0.000944,0.000000}, {0.000985,0.000000}, {0.001026,0.000000}, {0.001068,0.000000},
    {0.001110,0.000000}, {0.001153,0.000000}, {0.001197,0.000000}, {0.001241,0.000000},
    {0.001285,0.000000}, {0.001330,0.000000}, {0.001376,0.000000}, {0.001421,0.000000},
    {0.001468,0.000000}, {0.001514,0.000000}, {0.001561,0.000000}, {0.001608,0.000000},
    {0.001655,0.000000}, {0.001703,0.000000}, {0.001751,0.000000}, {0.001799,0.000000},
    {0.001847,0.000000}, {0.001896,0.000000}, {0.001944,0.000000}, {0.001993,0.000000},
    {0.002042,0.000000}, {0.002091,0.000000}, {0.002140,0.000000}, {0.002189,0.000000},
    {0.002238,0.000000}, {0.002286,0.000000}, {0.002335,0.000000}, {0.002384,0.000000},
    {0.002433,0.000000}, {0.002481,0.000000}, {0.002529,0.000000}, {0.002577,0.000000},
    {0.002625,0.000000}, {0.002673,0.000000}, {0.002720,0.000000}, {0.002768,0.000000},
    {0.002814,0.000000}, {0.002861,0.000000}, {0.002907,0.000000}, {0.002953,0.000000},
    {0.002998,0.000000}, {0.003043,0.000000}, {0.003087,0.000000}, {0.003131,0.000000},
    {0.003175,0.000000}, {0.003218,0.000000}, {0.003260,0.000000}, {0.003302,0.000000},
    {0.003344,0.000000}, {0.003384,0.000000}, {0.003424,0.000000}, {0.003464,0.000000},
    {0.003503,0.000000}, {0.003541,0.000000}, {0.003578,0.000000}, {0.003615,0.000000},
    {0.003651,0.000000}, {0.003686,0.000000}, {0.003720,0.000000}, {0.003754,0.000000},
    {0.003787,0.000000}, {0.003819,0.000000}, {0.003850,0.000000}, {0.003880,0.000000},
    {0.003909,0.000000}, {0.003938,0.000000}, {0.003965,0.000000}, {0.003992,0.000000},
    {0.004018,0.000000}, {0.004043,0.000000}, {0.004066,0.000000}, {0.004089,0.000000},
    {0.004111,0.000000}, {0.004132,0.000000}, {0.004152,0.000000}, {0.004171,0.000000},
    {0.004188,0.000000}, {0.004205,0.000000}, {0.004221,0.000000}, {0.004236,0.000000},
    {0.004249,0.000000}, {0.004262,0.000000}, {0.004273,0.000000}, {0.004284,0.000000},
    {0.004293,0.000000}, {0.004301,0.000000}, {0.004309,0.000000}, {0.004315,0.000000},
    {0.004320,0.000000}, {0.004323,0.000000}, {0.004326,0.000000}, {0.004328,0.000000}
    };

static const float W_expect[] = {
    0.601647, 0.495616, 0.262390, 0.065359, -0.012196, -0.008645, 0.004429, 0.002195,
    -0.002176, -0.000597, 0.001208, 0.000079, -0.000708, 0.000102, 0.000421, -0.000158,
    -0.000246, 0.000163, 0.000135, -0.000148, -0.000064, 0.000124, 0.000019, -0.000099,
    0.000009, 0.000075, -0.000025, -0.000053, 0.000033, 0.000035, -0.000035, -0.000020,
    0.000034, 0.000009, -0.000030, 0.000000, 0.000025, -0.000007, -0.000020, 0.000011,
    0.000014, -0.000013, -0.000009, 0.000013, 0.000005, -0.000013, -0.000001, 0.000012,
    -0.000002, -0.000010, 0.000004, 0.000007, -0.000006, -0.000005, 0.000006, 0.000003,
    -0.000007, -0.000001, 0.000006, -0.000001, -0.000005, 0.000002, 0.000004, -0.000003,
    -0.000003, 0.000003, 0.000002, -0.000004, -0.000001, 0.000004, -0.000000, -0.000003,
    0.000001, 0.000003, -0.000002, -0.000002, 0.000002, 0.000001, -0.000002, -0.000001,
    0.000002, 0.000000, -0.000002, 0.000000, 0.000002, -0.000001, -0.000002, 0.000001,
    0.000001, -0.000001, -0.000001, 0.000002, 0.000000, -0.000001, 0.000000, 0.000001,
    -0.000001, -0.000001, 0.000001, 0.000001, -0.000001, -0.000001, 0.000001, 0.000000,
    -0.000001, 0.000000, 0.000001, -0.000000, -0.000001, 0.000000, 0.000001, -0.000001,
    -0.000000, 0.000001, 0.000000, -0.000001, -0.000000, 0.000001, -0.000000, -0.000001,
    0.000000, 0.000001, -0.000000, -0.000000, 0.000001, 0.000000, -0.000001, -0.000000,
    0.000001, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000,
    0.000000, -0.000000, -0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000,
    -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000,
    -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000,
    -0.000000, 0.000000, 0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000,
    0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, 0.000000,
    0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000,
    0.000000, -0.000000, -0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000,
    -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, -0.000000,
    -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000,
    -0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000,
    0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, 0.000000,
    0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000,
    0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000,
    -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, 0.000000, 0.000000, -0.000000,
    -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, 0.000000,
    0.000000, 0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000,
    -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, 0.000000, 0.000000, -0.000000,
    -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000,
    0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000,
    0.000000, 0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000,
    0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000,
    -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000,
    -0.000000, -0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000,
    -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, -0.000000, -0.000000,
    0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000,
    0.000000, 0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000,
    0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, 0.000000, 0.000000,
    -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000,
    -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000,
    -0.000000, 0.000000, 0.000000, -0.000000, -0.000000, 0.000000, -0.000000, -0.000000,
    0.000000, 0.000000, -0.000000, -0.000000, 0.000000, 0.000000, -0.000000, -0.000000,
    0.000001, -0.000000, -0.000001, 0.000000, 0.000001, -0.000000, -0.000000, 0.000001,
    0.000000, -0.000001, -0.000000, 0.000001, -0.000000, -0.000001, 0.000000, 0.000001,
    -0.000000, -0.000001, 0.000001, 0.000000, -0.000001, -0.000000, 0.000001, 0.000000,
    -0.000001, 0.000000, 0.000001, -0.000001, -0.000001, 0.000001, 0.000001, -0.000001,
    -0.000001, 0.000001, 0.000000, -0.000001, 0.000000, 0.000002, -0.000001, -0.000001,
    0.000001, 0.000001, -0.000002, -0.000001, 0.000002, 0.000000, -0.000002, 0.000000,
    0.000002, -0.000001, -0.000002, 0.000001, 0.000002, -0.000002, -0.000002, 0.000003,
    0.000001, -0.000003, -0.000000, 0.000004, -0.000001, -0.000004, 0.000002, 0.000003,
    -0.000003, -0.000003, 0.000004, 0.000002, -0.000005, -0.000001, 0.000006, -0.000001,
    -0.000007, 0.000003, 0.000006, -0.000005, -0.000006, 0.000007, 0.000004, -0.000010,
    -0.000002, 0.000012, -0.000001, -0.000013, 0.000005, 0.000013, -0.000009, -0.000013,
    0.000014, 0.000011, -0.000020, -0.000007, 0.000025, 0.000000, -0.000030, 0.000009,
    0.000034, -0.000020, -0.000035, 0.000035, 0.000033, -0.000053, -0.000025, 0.000075,
    0.000009, -0.000099, 0.000019, 0.000124, -0.000064, -0.000148, 0.000135, 0.000163,
    -0.000246, -0.000158, 0.000421, 0.000102, -0.000708, 0.000079, 0.001208, -0.000597,
    -0.002176, 0.002195, 0.004429, -0.008645, -0.012196, 0.065359, 0.262390, 0.495616
    };


int float_cmp(float a, float b) {
    if ( fabsf(a - b) < 5e-6f ) return 1;
    else return 0;
    }

int main(int argc, char *argv[]) {

    COMP          W[FFT_ENC];
    codec2_fft_cfg  fft_fwd_cfg;
    int i;

    ////////
    // Semihosting
    semihosting_init();

    ////////
    fft_fwd_cfg = malloc(sizeof(codec2_fft_struct));
    fft_fwd_cfg->inverse  = 0;
    fft_fwd_cfg->instance = &arm_cfft_sR_f32_len512;

    /////////////////
    //codec2_fft(fft_fwd_cfg, wshift, W);
    printf("size allocated for W = %d\n", (FFT_ENC * sizeof(COMP)));
    printf("size copied to = %d\n", fft_fwd_cfg->instance->fftLen*2*sizeof(float));
    memcpy(W, wshift, fft_fwd_cfg->instance->fftLen*2*sizeof(float));
    arm_cfft_f32(fft_fwd_cfg->instance, (float*)W, fft_fwd_cfg->inverse,0);
    /////////////////

    for (i=0; i<FFT_ENC; i++) {
        printf("W[%d] = %f", i, (double)W[i].real);
        if (!float_cmp(W[i].real, W_expect[i])) {
            printf(" Error, expected %f", (double)W_expect[i]);
            }
        printf("\n");
        }

    fclose(stdout);
    fclose(stderr);

    return(0);
}

/* vi:set ts=4 et sts=4: */
